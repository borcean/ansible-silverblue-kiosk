# Generated by Anaconda 42.27.12
# Generated by pykickstart v3.62
#version=DEVEL

%post --erroronfail
cp /etc/skel/.bash* /root

cat << 'EOF' > /etc/systemd/system/rpm-ostree-kiosk-packages.service
[Unit]
Description=Layer ansible with rpm-ostree
Wants=network-online.target
After=network-online.target
ConditionPathExists=!/usr/bin/gnome-kiosk-script
ConditionPathExists=!/var/lib/%N.stamp

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive ansible
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive python3-rpm
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive dbus-x11
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive gnome-kiosk-script-session
ExecStart=/bin/touch /var/lib/%N.stamp
ExecStart=/bin/systemctl --no-block reboot

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable the unit
systemctl enable rpm-ostree-kiosk-packages.service

cat << 'EOF' > /etc/systemd/system/ansible-bootstrap.service
[Unit]
Description=Ansible pull service
Wants=network-online.target
After=network-online.target
ConditionPathExists=/usr/bin/ansible
ConditionPathExists=/usr/bin/gnome-kiosk-script
ConditionPathExists=!/var/lib/%N.stamp

[Service]
Type=oneshot
ExecStart=/usr/bin/ansible-pull -U https://github.com/borcean/ansible-silverblue-kiosk.git -C main
ExecStart=/bin/touch /var/lib/%N.stamp
ExecStart=/bin/systemctl --no-block reboot

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable the unit
systemctl enable ansible-bootstrap.service

%end

# Restart the system after installation
reboot --eject

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Network configuration
network --hostname=display.tumwater

# Firewall configuration
firewall --use-system-defaults

# OSTree setup
ostreesetup --osname="fedora" --remote="fedora" --url="file:///ostree/repo" --ref="fedora/42/x86_64/silverblue" --nogpg

# Run the Setup Agent on first boot
firstboot --disable

# Partition clearing information
zerombr
clearpart --drives=sda --all

# Generated using Blivet version 3.12.1
ignoredisk --only-use=sda
autopart

timesource --ntp-server=time-cc.beaverton.k12.or.us
timesource --ntp-server=time-co.beaverton.k12.or.us
# System timezone
timezone America/Los_Angeles --utc

#Root password
rootpw --lock
