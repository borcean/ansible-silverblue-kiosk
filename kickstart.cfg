# Generated by Anaconda 43.44

%pre --interpreter=/usr/bin/bash
# Detect install disk (sda, nvme0n1, vda, etc)
# Note: This is not used yet, but could be useful for more complex setups
DISK=$(lsblk -ndo NAME,TYPE | awk '$2=="disk"{print $1; exit}')

# Write full KS directives so %include can import them correctly
echo "ignoredisk --only-use=$DISK" > /tmp/ignoredisk.ks
echo "clearpart --drives=$DISK --all --initlabel" > /tmp/clearpart.ks

%end

%post --erroronfail
cp /etc/skel/.bash* /root

cat << 'EOF' > /etc/systemd/system/rpm-ostree-kiosk-packages.service
[Unit]
Description=Layer ansible with rpm-ostree
Wants=network-online.target
After=network-online.target
ConditionPathExists=!/usr/bin/gnome-kiosk-script
ConditionPathExists=!/var/lib/%N.stamp

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive ansible
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive python3-rpm
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive dbus-x11
ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive gnome-kiosk-script-session
ExecStart=/bin/touch /var/lib/%N.stamp
ExecStart=/bin/systemctl --no-block reboot

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable the unit
systemctl enable rpm-ostree-kiosk-packages.service

cat << 'EOF' > /etc/systemd/system/ansible-bootstrap.service
[Unit]
Description=Ansible pull service
Wants=network-online.target
After=network-online.target
ConditionPathExists=/usr/bin/ansible
ConditionPathExists=/usr/bin/gnome-kiosk-script
ConditionPathExists=!/var/lib/%N.stamp

[Service]
Type=oneshot
ExecStart=/usr/bin/ansible-pull -U https://github.com/borcean/ansible-silverblue-kiosk.git -C main
ExecStart=/bin/touch /var/lib/%N.stamp
ExecStart=/bin/systemctl --no-block reboot

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable the unit
systemctl enable ansible-bootstrap.service

# Mask all suspend-related systemd targets
systemctl mask \
    sleep.target \
    suspend.target \
    hibernate.target \
    hybrid-sleep.target
%end

# Restart the system after installation
reboot --eject

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Network configuration
network --hostname=display.tumwater

# Firewall configuration
firewall --use-system-defaults

# OSTree setup
ostreesetup --osname="fedora" --remote="fedora" --url="file:///ostree/repo" --ref="fedora/43/x86_64/silverblue" --nogpg

# Run the Setup Agent on first boot
firstboot --disable

# Partition clearing information
zerombr
clearpart --drives=sda --all

# Generated using Blivet version 3.12.1
ignoredisk --only-use=sda
autopart

timesource --ntp-server=time-cc.beaverton.k12.or.us
timesource --ntp-server=time-co.beaverton.k12.or.us
# System timezone
timezone America/Los_Angeles --utc

#Root password
rootpw --lock
